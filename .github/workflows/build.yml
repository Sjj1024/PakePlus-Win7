name: Build Windows

on:
    push:
        tags:
            - 'v*'
    workflow_dispatch:
        inputs:
            version:
                description: '版本号 (例如: 1.0.0)'
                required: false
                default: ''

permissions:
    contents: write

jobs:
    build-windows:
        runs-on: windows-latest

        strategy:
            matrix:
                arch: [ia32, x64]

        steps:
            - name: 检出代码
              uses: actions/checkout@v4

            - name: 设置 Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '18'
                  cache: 'npm'

            - name: 安装依赖
              run: npm ci

            - name: 获取版本号
              id: version
              run: |
                  if ("${{ github.event_name }}" -eq "workflow_dispatch" -and "${{ github.event.inputs.version }}" -ne "") {
                    echo "version=${{ github.event.inputs.version }}" >> $env:GITHUB_OUTPUT
                  } else {
                    $packageJson = Get-Content package.json | ConvertFrom-Json
                    echo "version=$($packageJson.version)" >> $env:GITHUB_OUTPUT
                  }
              shell: pwsh

            - name: 构建 Windows (${{ matrix.arch }})
              run: npm run build:win -- --${{ matrix.arch }}
              env:
                  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            - name: 列出构建产物
              run: dir dist /B
              shell: cmd

            - name: 上传构建产物
              uses: actions/upload-artifact@v4
              with:
                  name: windows-${{ matrix.arch }}
                  path: dist/*.exe
                  retention-days: 30

    release:
        needs: build-windows
        runs-on: ubuntu-latest
        if: startsWith(github.ref, 'refs/tags/v') || github.event_name == 'workflow_dispatch'

        permissions:
            contents: write

        steps:
            - name: 检出代码
              uses: actions/checkout@v4

            - name: 获取版本号
              id: version
              run: |
                  if [ "${{ github.event_name }}" == "workflow_dispatch" ] && [ -n "${{ github.event.inputs.version }}" ]; then
                    echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
                  else
                    VERSION=$(node -p "require('./package.json').version")
                    echo "version=$VERSION" >> $GITHUB_OUTPUT
                  fi

            - name: 下载所有构建产物
              uses: actions/download-artifact@v4
              with:
                  path: artifacts
                  pattern: windows-*
                  merge-multiple: true

            - name: 列出下载的文件结构
              run: |
                  echo "=== 文件结构 ==="
                  find artifacts -type f -name "*.exe" | sort
                  echo "=== 文件详情 ==="
                  ls -la artifacts/
                  if [ -d "artifacts/windows-ia32" ]; then
                    echo "=== windows-ia32 目录 ==="
                    ls -la artifacts/windows-ia32/
                  fi
                  if [ -d "artifacts/windows-x64" ]; then
                    echo "=== windows-x64 目录 ==="
                    ls -la artifacts/windows-x64/
                  fi

            - name: 重命名文件（修复版本号）
              run: |
                  # 查找所有 .exe 文件并重命名错误的版本号
                  for file in artifacts/*.exe; do
                    if [ -f "$file" ]; then
                      # 将 1.0.0 替换为正确的版本号
                      new_file=$(echo "$file" | sed "s/1\.0\.0/${{ steps.version.outputs.version }}/g")
                      if [ "$file" != "$new_file" ]; then
                        mv "$file" "$new_file"
                        echo "重命名: $file -> $new_file"
                      fi
                    fi
                  done

                  # 处理子目录中的文件
                  find artifacts -name "*.exe" -type f | while read file; do
                    # 将 1.0.0 替换为正确的版本号
                    new_file=$(echo "$file" | sed "s/1\.0\.0/${{ steps.version.outputs.version }}/g")
                    if [ "$file" != "$new_file" ]; then
                      mv "$file" "$new_file"
                      echo "重命名: $file -> $new_file"
                    fi
                  done

            - name: 创建 Release
              uses: softprops/action-gh-release@v1
              with:
                  tag_name: ${{ github.ref_name }}
                  name: Release v${{ steps.version.outputs.version }}
                  body: |
                      ## Windows 版本发布 v${{ steps.version.outputs.version }}

                      自动构建的 Windows 版本，包含 32位 和 64位 架构。

                      ### 文件说明
                      - `*setup.exe`: 安装程序版本
                      - `*.exe` (非setup): 便携版本

                      ### 系统要求
                      - Windows 7 或更高版本
                      - 请根据您的系统架构选择对应的版本
                  files: |
                      artifacts/**/*.exe
                  draft: false
                  prerelease: false
